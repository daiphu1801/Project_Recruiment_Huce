@model Project_Recruiment_Huce.Areas.Admin.Models.InterviewListViewModel
@{
    ViewBag.Title = "Quản lý lịch phỏng vấn";
    Layout = "~/Areas/Admin/Views/Shared/_Layout.cshtml";
}

@Html.Partial("~/Areas/Admin/Views/Shared/_Breadcrumbs.cshtml")

<div class="app-content">
    <div class="container-fluid">
        <!-- Filter Panel -->
        <div class="card mb-4">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="bi bi-funnel me-2"></i>
                    Bộ lọc tìm kiếm
                </h3>
                <div class="card-tools">
                    <button type="button" class="btn btn-tool" data-lte-toggle="card-collapse">
                        <i data-lte-icon="expand" class="bi bi-plus-lg"></i>
                        <i data-lte-icon="collapse" class="bi bi-dash-lg"></i>
                    </button>
                </div>
            </div>
            <div class="card-body">
                @using (Html.BeginForm("Index", "InterviewManagement", new { area = "Admin" }, FormMethod.Get, new { @class = "row g-3" }))
                {
                    <div class="col-md-3">
                        <label for="fromDate" class="form-label">Từ ngày</label>
                        @Html.TextBoxFor(m => m.Filters.FromDate, new { @class = "form-control", type = "date" })
                    </div>
                    <div class="col-md-3">
                        <label for="toDate" class="form-label">Đến ngày</label>
                        @Html.TextBoxFor(m => m.Filters.ToDate, new { @class = "form-control", type = "date" })
                    </div>
                    <div class="col-md-3">
                        <label for="status" class="form-label">Trạng thái</label>
                        @Html.DropDownListFor(m => m.Filters.Status, 
                            new SelectList(new[] {
                                new { Value = "All", Text = "Tất cả" },
                                new { Value = "Pending", Text = "Chờ phỏng vấn" },
                                new { Value = "Completed", Text = "Đã hoàn thành" },
                                new { Value = "Cancelled", Text = "Đã hủy" }
                            }, "Value", "Text", Model.Filters.Status), 
                            new { @class = "form-select" })
                    </div>
                    <div class="col-md-3">
                        <label for="interviewType" class="form-label">Hình thức</label>
                        @Html.DropDownListFor(m => m.Filters.InterviewType, 
                            new SelectList(new[] {
                                new { Value = "All", Text = "Tất cả" },
                                new { Value = "Offline", Text = "Trực tiếp" },
                                new { Value = "Online", Text = "Trực tuyến" },
                                new { Value = "Phone", Text = "Điện thoại" }
                            }, "Value", "Text", Model.Filters.InterviewType), 
                            new { @class = "form-select" })
                    </div>
                    <div class="col-md-6">
                        <label for="searchTerm" class="form-label">Tìm kiếm</label>
                        @Html.TextBoxFor(m => m.Filters.SearchTerm, new { @class = "form-control", placeholder = "Tìm theo tên ứng viên, công việc..." })
                    </div>
                    <div class="col-md-3">
                        <label for="sortBy" class="form-label">Sắp xếp theo</label>
                        @Html.DropDownListFor(m => m.Filters.SortBy, 
                            new SelectList(new[] {
                                new { Value = "InterviewDate", Text = "Ngày PV" },
                                new { Value = "CreatedAt", Text = "Ngày tạo" },
                                new { Value = "CandidateName", Text = "Tên ứng viên" }
                            }, "Value", "Text", Model.Filters.SortBy), 
                            new { @class = "form-select" })
                    </div>
                    <div class="col-md-3">
                        <label for="sortOrder" class="form-label">Thứ tự</label>
                        @Html.DropDownListFor(m => m.Filters.SortOrder, 
                            new SelectList(new[] {
                                new { Value = "Desc", Text = "Giảm dần" },
                                new { Value = "Asc", Text = "Tăng dần" }
                            }, "Value", "Text", Model.Filters.SortOrder), 
                            new { @class = "form-select" })
                    </div>
                    <div class="col-12">
                        <button type="submit" class="btn btn-primary me-2">
                            <i class="bi bi-search me-1"></i>
                            Tìm kiếm
                        </button>
                        <a href="@Url.Action("Index", "InterviewManagement", new { area = "Admin" })" class="btn btn-outline-secondary">
                            <i class="bi bi-arrow-counterclockwise me-1"></i>
                            Đặt lại
                        </a>
                        <a href="@Url.Action("Dashboard", "InterviewManagement", new { area = "Admin" })" class="btn btn-outline-info">
                            <i class="bi bi-bar-chart me-1"></i>
                            Thống kê
                        </a>
                    </div>
                }
            </div>
        </div>

        <!-- Interview List -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="bi bi-calendar-check me-2"></i>
                    Danh sách lịch phỏng vấn
                    <span class="badge text-bg-secondary ms-2">@Model.TotalItems</span>
                </h3>
                <div class="card-tools">
                    <button type="button" class="btn btn-sm btn-success me-2">
                        <i class="bi bi-file-earmark-excel me-1"></i>
                        Xuất Excel
                    </button>
                    <button type="button" class="btn btn-sm btn-danger">
                        <i class="bi bi-file-earmark-pdf me-1"></i>
                        Xuất PDF
                    </button>
                </div>
            </div>
            <div class="card-body table-responsive p-0">
                <table class="table table-hover text-nowrap">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Ứng viên</th>
                            <th>Công việc</th>
                            <th>Ngày PV</th>
                            <th>Hình thức</th>
                            <th class="text-end">Thao tác</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (Model.Interviews != null && Model.Interviews.Any())
                        {
                            foreach (var interview in Model.Interviews)
                            {
                                <tr>
                                    <td><strong>#@interview.InterviewID</strong></td>
                                    <td>
                                        <div class="fw-bold">@interview.CandidateName</div>
                                        <small class="text-muted">@interview.CandidateEmail</small>
                                    </td>
                                    <td>
                                        <a href="@Url.Action("Details", "JobPosts", new { area = "Admin", id = interview.JobID })" 
                                           class="link-primary">
                                            @interview.JobTitle
                                        </a>
                                    </td>
                                    <td>
                                        <div>
                                            <i class="bi bi-calendar3 me-1"></i>
                                            @interview.InterviewDate.ToString("dd/MM/yyyy")
                                        </div>
                                        <small class="text-muted">
                                            <i class="bi bi-clock me-1"></i>@interview.InterviewTime
                                        </small>
                                    </td>
                                    <td>
                                        @if (interview.InterviewType == "Offline")
                                        {
                                            <span class="badge text-bg-primary">
                                                <i class="bi bi-person-workspace me-1"></i>Trực tiếp
                                            </span>
                                        }
                                        else if (interview.InterviewType == "Online")
                                        {
                                            <span class="badge text-bg-info">
                                                <i class="bi bi-camera-video me-1"></i>Trực tuyến
                                            </span>
                                        }
                                        else
                                        {
                                            <span class="badge text-bg-secondary">
                                                <i class="bi bi-telephone me-1"></i>Điện thoại
                                            </span>
                                        }
                                    </td>
                                    <td class="text-end" style="white-space:nowrap;">
                                        <a class="btn btn-sm btn-outline-primary" 
                                           href="@Url.Action("Details", "InterviewManagement", new { area = "Admin", id = interview.InterviewID })" 
                                           title="Chi tiết">
                                            <i class="bi bi-eye me-1"></i>Chi tiết
                                        </a>
                                        <button type="button" class="btn btn-sm btn-outline-danger" 
                                                onclick="confirmCancel(@interview.InterviewID)" 
                                                title="Hủy lịch">
                                            <i class="bi bi-trash me-1"></i>Hủy
                                        </button>
                                    </td>
                                </tr>
                            }
                        }
                        else
                        {
                            <tr>
                                <td colspan="6" class="text-center py-4 text-muted">
                                    <i class="bi bi-inbox" style="font-size: 3rem;"></i>
                                    <p class="mt-2">Không tìm thấy lịch phỏng vấn nào</p>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
            @if (Model.TotalPages > 1)
            {
                <div class="card-footer clearfix">
                    <div class="row">
                        <div class="col-md-6">
                            <p class="text-muted">
                                Hiển thị @((Model.CurrentPage - 1) * Model.PageSize + 1) - 
                                @Math.Min(Model.CurrentPage * Model.PageSize, Model.TotalItems) 
                                trong tổng số @Model.TotalItems kết quả
                            </p>
                        </div>
                        <div class="col-md-6">
                            <ul class="pagination pagination-sm m-0 float-end">
                                <!-- Previous Page -->
                                @if (Model.CurrentPage > 1)
                                {
                                    <li class="page-item">
                                        <a class="page-link" href="@GetPageUrl(Model.CurrentPage - 1)">«</a>
                                    </li>
                                }
                                else
                                {
                                    <li class="page-item disabled">
                                        <span class="page-link">«</span>
                                    </li>
                                }

                                <!-- Page Numbers -->
                                @for (int i = Math.Max(1, Model.CurrentPage - 2); i <= Math.Min(Model.TotalPages, Model.CurrentPage + 2); i++)
                                {
                                    <li class="page-item @(i == Model.CurrentPage ? "active" : "")">
                                        <a class="page-link" href="@GetPageUrl(i)">@i</a>
                                    </li>
                                }

                                <!-- Next Page -->
                                @if (Model.CurrentPage < Model.TotalPages)
                                {
                                    <li class="page-item">
                                        <a class="page-link" href="@GetPageUrl(Model.CurrentPage + 1)">»</a>
                                    </li>
                                }
                                else
                                {
                                    <li class="page-item disabled">
                                        <span class="page-link">»</span>
                                    </li>
                                }
                            </ul>
                        </div>
                    </div>
                </div>
            }
        </div>
    </div>
</div>

<!-- Cancel Confirmation Modal -->
<div class="modal fade" id="cancelModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    Xác nhận hủy lịch phỏng vấn
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Bạn có chắc chắn muốn hủy lịch phỏng vấn này?</p>
                <p class="text-muted mb-0">
                    <i class="bi bi-info-circle me-1"></i>
                    Lưu ý: Hành động này không thể hoàn tác và email thông báo sẽ được gửi đến ứng viên.
                </p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                <button type="button" class="btn btn-danger" id="confirmCancelBtn">
                    <i class="bi bi-check-lg me-1"></i>
                    Xác nhận hủy
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        var cancelInterviewId = 0;
        var cancelModal = new bootstrap.Modal(document.getElementById('cancelModal'));

        function confirmCancel(interviewId) {
            cancelInterviewId = interviewId;
            cancelModal.show();
        }

        document.getElementById('confirmCancelBtn').addEventListener('click', function() {
            // TODO: Backend implementation - Call API to cancel interview
            console.log('Cancelling interview #' + cancelInterviewId);
            
            // Show success message (using AdminLTE toastr or similar)
            alert('Lịch phỏng vấn #' + cancelInterviewId + ' đã được hủy thành công!');
            
            cancelModal.hide();
            
            // Reload page or update row
            location.reload();
        });
    </script>
}

@functions {
    string GetPageUrl(int page)
    {
        var routeValues = new System.Web.Routing.RouteValueDictionary
        {
            { "area", "Admin" },
            { "page", page }
        };

        if (Model.Filters != null)
        {
            if (Model.Filters.FromDate.HasValue)
                routeValues.Add("fromDate", Model.Filters.FromDate.Value.ToString("yyyy-MM-dd"));
            if (Model.Filters.ToDate.HasValue)
                routeValues.Add("toDate", Model.Filters.ToDate.Value.ToString("yyyy-MM-dd"));
            if (!string.IsNullOrEmpty(Model.Filters.Status) && Model.Filters.Status != "All")
                routeValues.Add("status", Model.Filters.Status);
            if (!string.IsNullOrEmpty(Model.Filters.InterviewType) && Model.Filters.InterviewType != "All")
                routeValues.Add("interviewType", Model.Filters.InterviewType);
            if (!string.IsNullOrEmpty(Model.Filters.SearchTerm))
                routeValues.Add("searchTerm", Model.Filters.SearchTerm);
            if (!string.IsNullOrEmpty(Model.Filters.SortBy))
                routeValues.Add("sortBy", Model.Filters.SortBy);
            if (!string.IsNullOrEmpty(Model.Filters.SortOrder))
                routeValues.Add("sortOrder", Model.Filters.SortOrder);
        }

        return Url.Action("Index", "InterviewManagement", routeValues);
    }
}
