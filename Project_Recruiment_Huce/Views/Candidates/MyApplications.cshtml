@model IEnumerable<Project_Recruiment_Huce.Models.Candidates.ApplicationListItemViewModel>
@{
    ViewBag.Title = "Đơn ứng tuyển của tôi";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@section Styles {
    <link href="@Url.Content("~/Content/css/recruiters-application.css")?v=@DateTime.Now.Ticks" rel="stylesheet" type="text/css" />
    <link href="@Url.Content("~/Content/css/candidates-applications.css")?v=@DateTime.Now.Ticks" rel="stylesheet" type="text/css" />
}

<section class="section-hero overlay inner-page bg-image" style="background-image: url('@Url.Content("~/Content/images/hero_1.jpg")');" id="home-section">
  <div class="container">
    <div class="row">
      <div class="col-md-7">
        <h1 class="text-white font-weight-bold">
          <i class="icon-file-text mr-3"></i>Đơn ứng tuyển của tôi
        </h1>
        <div class="custom-breadcrumbs">
          <a href="@Url.Action("Index","Home")" class="breadcrumb-link">
            <i class="icon-home mr-1"></i>Trang chủ
          </a> 
          <span class="mx-2 slash">/</span>
          <a href="@Url.Action("CandidatesManage","Candidates")" class="breadcrumb-link">
            <i class="icon-user mr-1"></i>Hồ sơ của tôi
          </a> 
          <span class="mx-2 slash">/</span>
          <span class="text-white"><strong>Đơn ứng tuyển</strong></span>
        </div>
      </div>
    </div>
  </div>
</section>

<section class="site-section">
  <div class="container">

    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="icon-exclamation-triangle mr-2"></i>@TempData["ErrorMessage"]
            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
        </div>
    }

    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="icon-check-circle mr-2"></i>@TempData["SuccessMessage"]
            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
        </div>
    }

    @if (ViewBag.TotalItems != null)
    {
        <div class="stats-banner">
            <h4>
                <i class="icon-bar-chart mr-2"></i>Tổng quan đơn ứng tuyển
            </h4>
            <p>
                <i class="icon-file-text mr-2"></i>
                Bạn có <strong>@ViewBag.TotalItems</strong> đơn ứng tuyển
                @if (ViewBag.TotalPages != null && ViewBag.TotalPages > 1)
                {
                    <span class="ml-3">
                      <i class="icon-layers mr-2"></i>Trang <strong>@ViewBag.CurrentPage</strong> / <strong>@ViewBag.TotalPages</strong>
                    </span>
                }
            </p>
        </div>
    }

    @if (Model != null && Model.Any())
    {
        <div class="applications-grid">
            @foreach (var app in Model)
            {
                <div class="application-card @(app.IsRecent ? "recent" : "") @(app.IsExpired ? "expired" : "")">
                    <div class="card-header-app @(app.IsRecent ? "recent" : "") @(app.IsExpired ? "expired" : "")">
                        <div class="job-title-card">
                            <a href="@Url.Action("JobsDetails", "Jobs", new { id = app.JobPostID })">
                                @app.JobTitle
                            </a>
                        </div>
                        <div class="company-name-card">
                            <i class="icon-building"></i>
                            @app.CompanyName
                        </div>
                    </div>
                    
                    <div class="card-body-app">
                        <div class="job-meta-grid">
                            @if (!string.IsNullOrEmpty(app.Location))
                            {
                                <div class="job-meta-item-card">
                                    <i class="icon-map-marker"></i>
                                    <span>@app.Location</span>
                                </div>
                            }
                            @if (!string.IsNullOrEmpty(app.SalaryRange))
                            {
                                <div class="job-meta-item-card">
                                    <i class="icon-money"></i>
                                    <span>@app.SalaryRange</span>
                                </div>
                            }
                            @if (app.ApplicationDeadline.HasValue)
                            {
                                <div class="job-meta-item-card">
                                    <i class="icon-calendar"></i>
                                    <span>
                                        Hạn: @app.ApplicationDeadline.Value.ToString("dd/MM/yyyy")
                                        @if (app.IsExpired)
                                        {
                                            <span class="badge badge-danger ml-2" style="font-size: 0.75rem;">Hết hạn</span>
                                        }
                                    </span>
                                </div>
                            }
                        </div>

                        <div class="status-row">
                            <div>
                                @{
                                    string statusClass = "badge-warning";
                                    string statusDisplay = "Đang xem xét";
                                    string statusIcon = "icon-clock-o";
                                    if (!string.IsNullOrEmpty(app.Status))
                                    {
                                        string statusLower = app.Status.ToLower();
                                        if (statusLower == "under review" || statusLower == "pending")
                                        {
                                            statusDisplay = "Đang xem xét";
                                            statusClass = "badge-warning";
                                            statusIcon = "icon-clock-o";
                                        }
                                        else if (statusLower == "accepted" || statusLower == "approved")
                                        {
                                            statusDisplay = "Đã chấp nhận";
                                            statusClass = "badge-success";
                                            statusIcon = "icon-check-circle";
                                        }
                                        else if (statusLower == "rejected" || statusLower == "declined")
                                        {
                                            statusDisplay = "Đã từ chối";
                                            statusClass = "badge-danger";
                                            statusIcon = "icon-times-circle";
                                        }
                                        else if (statusLower == "interview" || statusLower == "interview scheduled")
                                        {
                                            statusDisplay = "Lịch phỏng vấn";
                                            statusClass = "badge-info";
                                            statusIcon = "icon-calendar-check-o";
                                        }
                                        else
                                        {
                                            statusDisplay = app.Status;
                                        }
                                    }
                                }
                                <span class="status-badge-card @statusClass">
                                    <i class="@statusIcon"></i>
                                    @statusDisplay
                                </span>
                            </div>
                            <div class="application-date-card">
                                <i class="icon-calendar"></i>
                                @(app.AppliedAt?.ToString("dd/MM/yyyy HH:mm") ?? "N/A")
                            </div>
                        </div>

                        @if (!string.IsNullOrEmpty(app.Note))
                        {
                            <div class="note-section-card">
                                <strong>
                                    <i class="icon-comment"></i>
                                    Ghi chú của bạn:
                                </strong>
                                <div class="note-content-card">
                                    @app.Note
                                </div>
                            </div>
                        }

                        <div class="card-actions">
                            @if (!string.IsNullOrEmpty(app.ResumeFilePath))
                            {
                                <a href="@Url.Content(app.ResumeFilePath)" target="_blank" class="btn-view-cv">
                                    <i class="icon-file-pdf"></i> Xem CV
                                </a>
                            }
                            <a href="@Url.Action("ApplicationDetails", "Candidates", new { id = app.ApplicationID })" class="btn-details">
                                <i class="icon-eye"></i>Xem chi tiết
                            </a>
                        </div>
                    </div>
                </div>
            }
        </div>
    }
    
    <!-- Pagination -->
    @if (Model != null && Model.Any() && ViewBag.TotalPages != null && ViewBag.TotalPages > 1)
    {
        <div class="pagination-wrapper">
            <div class="pagination-custom">
                @if (ViewBag.CurrentPage > 1)
                {
                    <a href="@Url.Action("MyApplications", new { page = ViewBag.CurrentPage - 1 })">
                        <i class="icon-angle-left"></i> Trước
                    </a>
                }
                
                @for (int i = 1; i <= ViewBag.TotalPages; i++)
                {
                    if (i == ViewBag.CurrentPage)
                    {
                        <span class="active">@i</span>
                    }
                    else
                    {
                        <a href="@Url.Action("MyApplications", new { page = i })">@i</a>
                    }
                }
                
                @if (ViewBag.CurrentPage < ViewBag.TotalPages)
                {
                    <a href="@Url.Action("MyApplications", new { page = ViewBag.CurrentPage + 1 })">
                        Sau <i class="icon-angle-right"></i>
                    </a>
                }
            </div>
        </div>
    }
    
    @if (Model == null || !Model.Any())
    {
        <div class="empty-state">
            <i class="icon-file-text"></i>
            <h3>Chưa có đơn ứng tuyển nào</h3>
            <p>Bạn chưa ứng tuyển công việc nào. Hãy bắt đầu tìm kiếm các vị trí tuyển dụng phù hợp!</p>
            <a href="@Url.Action("JobsListing", "Jobs")" class="btn btn-primary btn-lg">
                <i class="icon-search mr-2"></i>Tìm việc làm ngay
            </a>
        </div>
    }
  </div>
</section>