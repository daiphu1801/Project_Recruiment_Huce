@model Project_Recruiment_Huce.Models.Companies.CompanyManageViewModel
@{
    ViewBag.Title = "Quản lý công ty";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
<link rel="stylesheet" href="https://unpkg.com/leaflet-geosearch@3.8.0/dist/geosearch.css" />

<style>
    .map-container-style {
        background-color: #f8f9fa !important;
        padding: 1rem !important;
        border: 1px solid #dee2e6 !important;
        border-radius: 0.25rem !important;
    }

    #mapPicker {
        height: 450px;
        width: 100%;
        border-radius: 4px;
        z-index: 1;
    }

    .modal-dialog {
        max-width: 900px;
    }

    .leaflet-touch .leaflet-control-geosearch .leaflet-bar-part {
        border-radius: 4px;
        border: 2px solid rgba(0,0,0,0.2);
    }
</style>

<section class="section-hero overlay inner-page bg-image" style="background-image: url('@Url.Content("~/Content/images/hero_1.jpg")');" id="home-section">
    <div class="container">
        <div class="row">
            <div class="col-md-7">
                <h1 class="text-white font-weight-bold">Quản lý công ty</h1>
                <div class="custom-breadcrumbs">
                    <a href="@Url.Action("Index","Home")">Trang chủ</a> <span class="mx-2 slash">/</span>
                    <span class="text-white"><strong>Công ty</strong></span>
                </div>
            </div>
        </div>
    </div>
</section>

<section class="site-section">
    <div class="container">
        <div class="row mb-5">
            <div class="col-lg-12">
                @if (TempData["SuccessMessage"] != null)
                {
                    <div class="alert alert-success alert-dismissible fade show" role="alert">
                        @TempData["SuccessMessage"]
                        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                }

                @if (TempData["ErrorMessage"] != null)
                {
                    <div class="alert alert-danger alert-dismissible fade show" role="alert">
                        @TempData["ErrorMessage"]
                        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                }

                @using (Html.BeginForm("CompaniesManage", "Companies", FormMethod.Post, new { @class = "p-4 p-md-5 border rounded", id = "company-form", enctype = "multipart/form-data" }))
                {
                    @Html.AntiForgeryToken()
                    @Html.HiddenFor(m => m.CompanyID)

                    <h3 class="text-black mb-5 border-bottom pb-2">Thông tin công ty</h3>

                    <!-- Logo Upload Section -->
                    <div class="form-group">
                        <label for="Logo">Logo công ty</label>
                        @if (!string.IsNullOrEmpty(Model?.LogoUrl))
                        {
                            <div class="mb-3">
                                <img src="@Url.Content("~" + Model.LogoUrl)" alt="Logo công ty" style="max-width: 200px; max-height: 200px; border: 1px solid #ddd; border-radius: 4px; padding: 5px;" />
                                <p class="text-muted small mt-2">Logo hiện tại</p>
                            </div>
                        }
                        <input type="file" name="Logo" id="Logo" accept="image/*" class="form-control-file" />
                        <small class="form-text text-muted">Chỉ chấp nhận file ảnh (jpg, jpeg, png, gif, webp), tối đa 5MB</small>
                        @Html.ValidationMessageFor(m => m.Logo, "", new { @class = "text-danger" })
                    </div>

                    <div class="form-group">
                        <label for="CompanyName">Tên công ty <span class="text-danger">*</span></label>
                        @Html.TextBoxFor(m => m.CompanyName, new { @class = "form-control", placeholder = "Ví dụ: Công ty TNHH ABC" })
                        @Html.ValidationMessageFor(m => m.CompanyName, "", new { @class = "text-danger" })
                    </div>

                    <div class="form-row">
                        <div class="form-group col-md-6">
                            <label for="TaxCode">Mã số thuế</label>
                            @Html.TextBoxFor(m => m.TaxCode, new { @class = "form-control", placeholder = "0123456789" })
                            @Html.ValidationMessageFor(m => m.TaxCode, "", new { @class = "text-danger" })
                        </div>
                        <div class="form-group col-md-6">
                            <label for="Industry">Lĩnh vực hoạt động</label>
                            @Html.TextBoxFor(m => m.Industry, new { @class = "form-control", placeholder = "Ví dụ: Công nghệ thông tin" })
                            @Html.ValidationMessageFor(m => m.Industry, "", new { @class = "text-danger" })
                        </div>
                    </div>

                    <div class="form-row">
                        @Html.LabelFor(model => model.Address, htmlAttributes: new { @class = "control-label" })
                        <div class="input-group">
                            @Html.EditorFor(model => model.Address, new { htmlAttributes = new { @class = "form-control", @id = "LocationInput", placeholder = "Nhập địa chỉ hoặc chọn trên bản đồ..." } })
                            <div class="input-group-append">
                                <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#mapModal">
                                    <i class="icon-map-marker mr-2"></i>Chọn vị trí
                                </button>
                            </div>
                        </div>
                        @Html.ValidationMessageFor(model => model.Address, "", new { @class = "text-danger" })
                    </div>

                    <div class="form-row">
                        <div class="form-group col-md-4">
                            <label for="Phone">Số điện thoại</label>
                            @Html.TextBoxFor(m => m.Phone, new { @class = "form-control", placeholder = "090..." })
                            @Html.ValidationMessageFor(m => m.Phone, "", new { @class = "text-danger" })
                        </div>
                        <div class="form-group col-md-4">
                            <label for="Fax">Số fax</label>
                            @Html.TextBoxFor(m => m.Fax, new { @class = "form-control", placeholder = "024..." })
                            @Html.ValidationMessageFor(m => m.Fax, "", new { @class = "text-danger" })
                        </div>
                        <div class="form-group col-md-4">
                            <label for="CompanyEmail">Email công ty</label>
                            @Html.TextBoxFor(m => m.CompanyEmail, new { @class = "form-control", type = "email", placeholder = "contact@company.com" })
                            @Html.ValidationMessageFor(m => m.CompanyEmail, "", new { @class = "text-danger" })
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="Website">Website</label>
                        @Html.TextBoxFor(m => m.Website, new { @class = "form-control", placeholder = "https://www.company.com" })
                        @Html.ValidationMessageFor(m => m.Website, "", new { @class = "text-danger" })
                    </div>

                    <div class="form-group">
                        <label for="Description">Mô tả công ty</label>
                        @Html.HiddenFor(m => m.Description, new { id = "hiddenDescription" })

                        <div id="editor-container" style="height: 300px; background-color: #fff;"></div>

                        @Html.ValidationMessageFor(m => m.Description, "", new { @class = "text-danger" })
                        <small class="form-text text-muted">Bạn có thể sử dụng các công cụ định dạng để tạo mô tả đẹp mắt</small>
                    </div>

                    <div class="text-right">
                        <button type="submit" class="btn btn-primary btn-md">Lưu thông tin công ty</button>
                    </div>
                }
            </div>
        </div>
    </div>
</section>

<div class="modal fade" id="mapModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title text-primary"><i class="icon-map mr-2"></i>Chọn địa điểm làm việc</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="map-container-style mb-3">
                    <h6 class="text-primary mb-3"><i class="icon-search mr-2"></i>Tìm kiếm hoặc click vào bản đồ</h6>
                    <div id="mapPicker"></div>
                </div>
                <p class="text-muted small text-center mb-0">
                    * Sử dụng thanh tìm kiếm trên bản đồ để tìm nhanh vị trí tòa nhà/đường phố.
                </p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Đóng</button>
                <button type="button" class="btn btn-success" id="btnConfirmLocation">Xác nhận địa chỉ này</button>
            </div>
        </div>
    </div>
</div>

<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

@section Scripts {
    @Scripts.Render("~/bundles/jqueryval")

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="https://unpkg.com/leaflet-geosearch@3.8.0/dist/geosearch.umd.js"></script>

    <script>
        $(document).ready(function () {
            var map;
            var marker;
            var currentAddress = "";

            function cleanAddress(fullAddress) {
                if (!fullAddress) return "";

                var parts = fullAddress.split(',');

                var cleanedParts = parts.filter(function(part) {
                    var text = part.trim();
                    return !(/^\d{5,6}$/.test(text));
                });

                return cleanedParts.join(',').trim();
            }

            function updateLocation(lat, lng, displayName) {
                if (!displayName) {
                    $.ajax({
                        url: `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1`,
                        type: 'GET',
                        headers: { 'Accept-Language': 'vi-VN' },
                        success: function (data) {
                            if (data && data.display_name) {
                                processAddress(data.display_name);
                            }
                        }
                    });
                } else {
                    processAddress(displayName);
                }

                function processAddress(rawAddress) {
                    var finalAddress = cleanAddress(rawAddress);
                    currentAddress = finalAddress;

                    if (marker) {
                        marker.setLatLng([lat, lng])
                              .bindPopup(finalAddress)
                              .openPopup();
                    } else {
                        marker = L.marker([lat, lng]).addTo(map)
                                  .bindPopup(finalAddress)
                                  .openPopup();
                    }

                    map.setView([lat, lng], 16);
                }
            }

            $('#mapModal').on('shown.bs.modal', function () {
                if (!map) {
                    map = L.map('mapPicker').setView([21.0285, 105.8542], 13);

                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '&copy; OpenStreetMap contributors'
                    }).addTo(map);

                    const provider = new GeoSearch.OpenStreetMapProvider({
                        params: {
                            'accept-language': 'vi', 
                            countrycodes: 'vn',
                        },
                    });

                    const searchControl = new GeoSearch.GeoSearchControl({
                        provider: provider,
                        style: 'bar',
                        showMarker: false,
                        searchLabel: 'Nhập tên đường, tòa nhà...',
                        keepResult: true,
                        updateMap: false
                    });

                    map.addControl(searchControl);

                    map.on('geosearch/showlocation', function (result) {
                        var lat = result.location.y;
                        var lng = result.location.x;
                        var label = result.location.label;
                        updateLocation(lat, lng, label);
                    });

                    map.on('click', function (e) {
                        updateLocation(e.latlng.lat, e.latlng.lng, null);
                    });
                } else {
                    setTimeout(function() { map.invalidateSize(); }, 100);
                }
            });

            $('#btnConfirmLocation').click(function() {
                if(currentAddress) {
                    $('#LocationInput').val(currentAddress);
                    $('#mapModal').modal('hide');
                    $('#LocationInput').valid();
                } else {
                    alert("Vui lòng chọn một vị trí trên bản đồ.");
                }
            });

                        var quill = new Quill('#editor-container', {
                                theme: 'snow',
                                placeholder: 'Mô tả về công ty, văn hóa, môi trường làm việc...',
                                modules: {
                                        toolbar: [
                                                [{ 'header': [1, 2, 3, false] }],
                                                ['bold', 'italic', 'underline', 'strike'],
                                                [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                                                ['blockquote', 'code-block'],
                                                ['link'],
                                                ['clean']
                                        ]
                                }
                        });

                        var initialContent = @Html.Raw(Json.Encode(Model.Description));
                        if (initialContent) {
                                quill.clipboard.dangerouslyPasteHTML(initialContent);
                        }

                        $('#company-form').on('submit', function(e) {
                                var htmlContent = quill.root.innerHTML;

                                $('#hiddenDescription').val(htmlContent);

                                console.log("Dữ liệu gửi đi:", htmlContent);
                        });
                });
    </script>
}
