@model Project_Recruiment_Huce.Models.Jobs.JobCreateViewModel
@{
    ViewBag.Title = "Chỉnh sửa tin tuyển dụng";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<!-- Quill Editor -->
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

<!-- HERO -->
<section class="section-hero overlay inner-page bg-image" style="background-image: url('@Url.Content("~/Content/images/hero_1.jpg")');" id="home-section">
    <div class="container">
        <div class="row">
            <div class="col-md-7">
                <h1 class="text-white font-weight-bold">Chỉnh sửa tin tuyển dụng</h1>
                <div class="custom-breadcrumbs">
                    <a href="@Url.Action("Index","Home")">Trang chủ</a> <span class="mx-2 slash">/</span>
                    <a href="@Url.Action("MyJobs","Jobs")">Tin tuyển dụng của tôi</a> <span class="mx-2 slash">/</span>
                    <span class="text-white"><strong>Chỉnh sửa</strong></span>
                </div>
            </div>
        </div>
    </div>
</section>

<section class="site-section">
    <div class="container">
        <div class="row mb-5">
            <div class="col-lg-12">
                @if (TempData["SuccessMessage"] != null)
                {
                    <div class="alert alert-success alert-dismissible fade show" role="alert">
                        @TempData["SuccessMessage"]
                        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                }

                @if (TempData["ErrorMessage"] != null)
                {
                    <div class="alert alert-danger alert-dismissible fade show" role="alert">
                        @TempData["ErrorMessage"]
                        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                }

                @using (Html.BeginForm("Edit", "Jobs", FormMethod.Post, new { @class = "p-4 p-md-5 border rounded", id = "job-edit-form" }))
                {
                    @Html.AntiForgeryToken()
                    @Html.ValidationSummary(true, "", new { @class = "text-danger" })
                    if (ViewBag.JobPostID != null)
                    {
                        <input type="hidden" name="id" value="@ViewBag.JobPostID" />
                    }

                    <h3 class="text-black mb-5 border-bottom pb-2">Thông tin công việc</h3>

                    <div class="form-group">
                        <label for="Title">Tiêu đề công việc <span class="text-danger">*</span></label>
                        @Html.TextBoxFor(m => m.Title, new { @class = "form-control", placeholder = "Ví dụ: Lập trình viên .NET" })
                        @Html.ValidationMessageFor(m => m.Title, "", new { @class = "text-danger" })
                    </div>

                    <div class="form-row">
                        <div class="form-group col-md-6">
                            <label for="Location">Địa điểm</label>
                            @Html.TextBoxFor(m => m.Location, new { @class = "form-control", placeholder = "Ví dụ: Hà Nội" })
                            @Html.ValidationMessageFor(m => m.Location, "", new { @class = "text-danger" })
                        </div>
                        <div class="form-group col-md-6">
                            <label for="EmploymentType">Hình thức làm việc</label>
                            @Html.DropDownListFor(m => m.EmploymentType, new SelectList(new[]
                            {
                                new SelectListItem { Text = "Toàn thời gian", Value = "Toàn thời gian" },
                                new SelectListItem { Text = "Bán thời gian", Value = "Bán thời gian" },
                                new SelectListItem { Text = "Thực tập", Value = "Thực tập" },
                                new SelectListItem { Text = "Hợp đồng", Value = "Hợp đồng" }
                            }, "Value", "Text", Model?.EmploymentType), "Chọn hình thức", new { @class = "form-control" })
                            @Html.ValidationMessageFor(m => m.EmploymentType, "", new { @class = "text-danger" })
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group col-md-4">
                            <label for="SalaryFrom">Lương từ</label>
                            @Html.TextBoxFor(m => m.SalaryFrom, new { @class = "form-control", type = "number", step = "0.01", placeholder = "0" })
                            @Html.ValidationMessageFor(m => m.SalaryFrom, "", new { @class = "text-danger" })
                        </div>
                        <div class="form-group col-md-4">
                            <label for="SalaryTo">Lương đến</label>
                            @Html.TextBoxFor(m => m.SalaryTo, new { @class = "form-control", type = "number", step = "0.01", placeholder = "0" })
                            @Html.ValidationMessageFor(m => m.SalaryTo, "", new { @class = "text-danger" })
                        </div>
                        <div class="form-group col-md-4">
                            <label for="SalaryCurrency">Đơn vị tiền tệ</label>
                            @Html.DropDownListFor(m => m.SalaryCurrency, new SelectList(new[]
                            {
                                new SelectListItem { Text = "VND", Value = "VND" },
                                new SelectListItem { Text = "USD", Value = "USD" },
                                new SelectListItem { Text = "EUR", Value = "EUR" }
                            }, "Value", "Text", Model?.SalaryCurrency ?? "VND"), new { @class = "form-control" })
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="ApplicationDeadline">Hạn nộp hồ sơ</label>
                        @Html.TextBoxFor(m => m.ApplicationDeadline, "{0:yyyy-MM-dd}", new { @class = "form-control", type = "date" })
                        @Html.ValidationMessageFor(m => m.ApplicationDeadline, "", new { @class = "text-danger" })
                    </div>

                    <div class="form-group">
                        <label for="Description">Mô tả công việc</label>
                        <div id="description-editor" style="min-height: 200px; margin-bottom: 10px;"></div>
                        @Html.TextAreaFor(m => m.Description, new { @class = "form-control", id = "description-textarea", rows = "10", style = "display: none;", placeholder = "Mô tả chi tiết về công việc..." })
                        @Html.ValidationMessageFor(m => m.Description, "", new { @class = "text-danger" })
                    </div>

                    <div class="form-group">
                        <label for="Requirements">Yêu cầu</label>
                        <div id="requirements-editor" style="min-height: 200px; margin-bottom: 10px;"></div>
                        @Html.TextAreaFor(m => m.Requirements, new { @class = "form-control", id = "requirements-textarea", rows = "10", style = "display: none;", placeholder = "Yêu cầu về kỹ năng, kinh nghiệm..." })
                        @Html.ValidationMessageFor(m => m.Requirements, "", new { @class = "text-danger" })
                    </div>

                    <h3 class="text-black my-5 border-bottom pb-2">Chi tiết yêu cầu</h3>

                    <div class="form-row">
                        <div class="form-group col-md-6">
                            <label for="Industry">Ngành nghề <span class="text-danger">*</span></label>
                            @Html.TextBoxFor(m => m.Industry, new { @class = "form-control", placeholder = "Ví dụ: Công nghệ thông tin" })
                            @Html.ValidationMessageFor(m => m.Industry, "", new { @class = "text-danger" })
                        </div>
                        <div class="form-group col-md-6">
                            <label for="Major">Chuyên ngành</label>
                            @Html.TextBoxFor(m => m.Major, new { @class = "form-control", placeholder = "Ví dụ: Lập trình phần mềm" })
                            @Html.ValidationMessageFor(m => m.Major, "", new { @class = "text-danger" })
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group col-md-4">
                            <label for="YearsExperience">Số năm kinh nghiệm</label>
                            @Html.TextBoxFor(m => m.YearsExperience, new { @class = "form-control", type = "number", min = "0", max = "50", placeholder = "0" })
                            @Html.ValidationMessageFor(m => m.YearsExperience, "", new { @class = "text-danger" })
                        </div>
                        <div class="form-group col-md-4">
                            <label for="DegreeRequired">Bằng cấp yêu cầu</label>
                            @Html.DropDownListFor(m => m.DegreeRequired, new SelectList(new[]
                            {
                                new SelectListItem { Text = "Không yêu cầu", Value = "Không yêu cầu" },
                                new SelectListItem { Text = "Trung cấp", Value = "Trung cấp" },
                                new SelectListItem { Text = "Cao đẳng", Value = "Cao đẳng" },
                                new SelectListItem { Text = "Đại học", Value = "Đại học" },
                                new SelectListItem { Text = "Thạc sĩ", Value = "Thạc sĩ" },
                                new SelectListItem { Text = "Tiến sĩ", Value = "Tiến sĩ" }
                            }, "Value", "Text", Model?.DegreeRequired), "Chọn bằng cấp", new { @class = "form-control" })
                            @Html.ValidationMessageFor(m => m.DegreeRequired, "", new { @class = "text-danger" })
                        </div>
                        <div class="form-group col-md-4">
                            <label for="Headcount">Số lượng cần tuyển</label>
                            @Html.TextBoxFor(m => m.Headcount, new { @class = "form-control", type = "number", min = "1", max = "1000", placeholder = "1" })
                            @Html.ValidationMessageFor(m => m.Headcount, "", new { @class = "text-danger" })
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="Skills">Kỹ năng</label>
                        <div id="skills-editor" style="min-height: 150px; margin-bottom: 10px;"></div>
                        @Html.TextAreaFor(m => m.Skills, new { @class = "form-control", id = "skills-textarea", rows = "5", style = "display: none;", placeholder = "Ví dụ: C#, ASP.NET, SQL Server..." })
                        @Html.ValidationMessageFor(m => m.Skills, "", new { @class = "text-danger" })
                        <small class="form-text text-muted">Bạn có thể sử dụng các công cụ định dạng để tạo danh sách kỹ năng đẹp mắt</small>
                    </div>

                    <div class="form-row">
                        <div class="form-group col-md-4">
                            <label for="GenderRequirement">Yêu cầu giới tính</label>
                            @Html.DropDownListFor(m => m.GenderRequirement, new SelectList(new[]
                            {
                                new SelectListItem { Text = "Không yêu cầu", Value = "Not required" },
                                new SelectListItem { Text = "Nam", Value = "Nam" },
                                new SelectListItem { Text = "Nữ", Value = "Nữ" }
                            }, "Value", "Text", Model?.GenderRequirement ?? "Not required"), new { @class = "form-control" })
                            @Html.ValidationMessageFor(m => m.GenderRequirement, "", new { @class = "text-danger" })
                        </div>
                        <div class="form-group col-md-4">
                            <label for="AgeFrom">Độ tuổi từ</label>
                            @Html.TextBoxFor(m => m.AgeFrom, new { @class = "form-control", type = "number", min = "16", max = "100", placeholder = "16" })
                            @Html.ValidationMessageFor(m => m.AgeFrom, "", new { @class = "text-danger" })
                        </div>
                        <div class="form-group col-md-4">
                            <label for="AgeTo">Độ tuổi đến</label>
                            @Html.TextBoxFor(m => m.AgeTo, new { @class = "form-control", type = "number", min = "16", max = "100", placeholder = "100" })
                            @Html.ValidationMessageFor(m => m.AgeTo, "", new { @class = "text-danger" })
                        </div>
                    </div>

                    <div class="text-right mt-4">
                        <a href="@Url.Action("MyJobs", "Jobs")" class="btn btn-secondary btn-md mr-2">Hủy</a>
                        <button type="submit" class="btn btn-primary btn-md">Cập nhật tin tuyển dụng</button>
                    </div>
                }
            </div>
        </div>
    </div>
</section>

<script>
    // Initialize Quill editor for Description
    var quillDescription = new Quill('#description-editor', {
        theme: 'snow',
        modules: {
            toolbar: [
                [{ 'header': [1, 2, 3, false] }],
                ['bold', 'italic', 'underline', 'strike'],
                [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                ['blockquote', 'code-block'],
                ['link'],
                ['clean']
            ]
        },
        placeholder: 'Mô tả chi tiết về công việc...'
    });

    // Initialize Quill editor for Requirements
    var quillRequirements = new Quill('#requirements-editor', {
        theme: 'snow',
        modules: {
            toolbar: [
                [{ 'header': [1, 2, 3, false] }],
                ['bold', 'italic', 'underline', 'strike'],
                [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                ['blockquote', 'code-block'],
                ['link'],
                ['clean']
            ]
        },
        placeholder: 'Yêu cầu về kỹ năng, kinh nghiệm...'
    });

    // Initialize Quill editor for Skills
    var quillSkills = new Quill('#skills-editor', {
        theme: 'snow',
        modules: {
            toolbar: [
                ['bold', 'italic', 'underline'],
                [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                ['clean']
            ]
        },
        placeholder: 'Ví dụ: C#, ASP.NET, SQL Server...'
    });

    // Set initial content if exists
    @if (Model != null && !string.IsNullOrEmpty(Model.Description))
    {
        <text>
        var initialDescription = @Html.Raw(Json.Encode(Model.Description));
        quillDescription.root.innerHTML = initialDescription;
        </text>
    }

    @if (Model != null && !string.IsNullOrEmpty(Model.Requirements))
    {
        <text>
        var initialRequirements = @Html.Raw(Json.Encode(Model.Requirements));
        quillRequirements.root.innerHTML = initialRequirements;
        </text>
    }

    @if (Model != null && !string.IsNullOrEmpty(Model.Skills))
    {
        <text>
        var initialSkills = @Html.Raw(Json.Encode(Model.Skills));
        quillSkills.root.innerHTML = initialSkills;
        </text>
    }

    // Update textarea fields before form submit
    document.getElementById('job-edit-form').addEventListener('submit', function(e) {
        // Prevent default submission to ensure values are set
        e.preventDefault();
        
        // Get HTML content from Quill editors
        var descriptionHtml = quillDescription.root.innerHTML;
        var requirementsHtml = quillRequirements.root.innerHTML;
        var skillsHtml = quillSkills.root.innerHTML;
        
        // Get textarea elements (they are hidden)
        var descriptionTextarea = document.getElementById('description-textarea');
        var requirementsTextarea = document.getElementById('requirements-textarea');
        var skillsTextarea = document.getElementById('skills-textarea');
        
        // Set values to textarea elements
        if (descriptionTextarea) {
            descriptionTextarea.value = descriptionHtml;
        }
        if (requirementsTextarea) {
            requirementsTextarea.value = requirementsHtml;
        }
        if (skillsTextarea) {
            skillsTextarea.value = skillsHtml;
        }
        
        // Now submit the form
        this.submit();
    });
</script>

