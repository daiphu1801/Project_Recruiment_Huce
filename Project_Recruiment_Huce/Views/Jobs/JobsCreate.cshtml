@model Project_Recruiment_Huce.Models.Jobs.JobCreateViewModel
@{
    bool isEditMode = ViewBag.IsEditMode != null && (bool)ViewBag.IsEditMode;
    ViewBag.Title = isEditMode ? "Chỉnh sửa tin tuyển dụng" : "Đăng tin tuyển dụng";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<!-- Quill Editor -->
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
<link rel="stylesheet" href="https://unpkg.com/leaflet-geosearch@3.8.0/dist/geosearch.css" />

<style>
    .map-container-style {
        background-color: #f8f9fa !important;
        padding: 1rem !important;
        border: 1px solid #dee2e6 !important;
        border-radius: 0.25rem !important;
    }

    #mapPicker {
        height: 450px;
        width: 100%;
        border-radius: 4px;
        z-index: 1;
    }

    .modal-dialog {
        max-width: 900px;
    }

    .leaflet-touch .leaflet-control-geosearch .leaflet-bar-part {
        border-radius: 4px;
        border: 2px solid rgba(0,0,0,0.2);
    }
</style>

<!-- HERO -->
<section class="section-hero overlay inner-page bg-image" style="background-image: url('@Url.Content("~/Content/images/hero_1.jpg")');" id="home-section">
    <div class="container">
        <div class="row">
            <div class="col-md-7">
                <h1 class="text-white font-weight-bold">@(isEditMode ? "Chỉnh sửa tin tuyển dụng" : "Đăng tin tuyển dụng")</h1>
                <div class="custom-breadcrumbs">
                    <a href="@Url.Action("Index","Home")">Trang chủ</a> <span class="mx-2 slash">/</span>
                    <a href="@Url.Action("MyJobs","Jobs")">Tin tuyển dụng của tôi</a> <span class="mx-2 slash">/</span>
                    <span class="text-white"><strong>@(isEditMode ? "Chỉnh sửa" : "Đăng tin tuyển dụng")</strong></span>
                </div>
            </div>
        </div>
    </div>
</section>

<section class="site-section">
    <div class="container">
        <div class="row mb-5">
            <div class="col-lg-12">
                @if (TempData["SuccessMessage"] != null)
                {
                    <div class="alert alert-success alert-dismissible fade show" role="alert">
                        @TempData["SuccessMessage"]
                        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                }

                @if (TempData["ErrorMessage"] != null)
                {
                    <div class="alert alert-danger alert-dismissible fade show" role="alert">
                        @TempData["ErrorMessage"]
                        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                }

                @using (Html.BeginForm(isEditMode ? "Edit" : "JobsCreate", "Jobs", FormMethod.Post, new { @class = "p-4 p-md-5 border rounded", id = "job-create-form" }))
                {
                    @Html.AntiForgeryToken()
                    @Html.ValidationSummary(true, "", new { @class = "text-danger" })
                    if (isEditMode && ViewBag.JobPostID != null)
                    {
                        <input type="hidden" name="id" value="@ViewBag.JobPostID" />
                    }

                    <h3 class="text-black mb-5 border-bottom pb-2">Thông tin công việc</h3>

                    <div class="form-group">
                        <label for="Title">Tiêu đề công việc <span class="text-danger">*</span></label>
                        @Html.TextBoxFor(m => m.Title, new { @class = "form-control", placeholder = "Ví dụ: Lập trình viên .NET" })
                        @Html.ValidationMessageFor(m => m.Title, "", new { @class = "text-danger" })
                    </div>

                    <div class="form-row">
                        <div class="form-group col-md-6">
                            @Html.LabelFor(model => model.Location, htmlAttributes: new { @class = "control-label" })
                            <div class="input-group">
                                @Html.EditorFor(model => model.Location, new { htmlAttributes = new { @class = "form-control", @id = "LocationInput", placeholder = "Nhập địa chỉ hoặc chọn trên bản đồ..." } })
                                <div class="input-group-append">
                                    <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#mapModal">
                                        <i class="icon-map-marker mr-2"></i>Chọn vị trí
                                    </button>
                                </div>
                            </div>
                            @Html.ValidationMessageFor(model => model.Location, "", new { @class = "text-danger" })
                        </div>

                        <div class="form-group col-md-6">
                            <label for="EmploymentType">Hình thức làm việc</label>
                            @Html.DropDownListFor(m => m.EmploymentType, new SelectList(new[]
                            {
                                new SelectListItem { Text = "Toàn thời gian", Value = "Toàn thời gian" },
                                new SelectListItem { Text = "Bán thời gian", Value = "Bán thời gian" },
                                new SelectListItem { Text = "Thực tập", Value = "Thực tập" },
                                new SelectListItem { Text = "Hợp đồng", Value = "Hợp đồng" }
                            }, "Value", "Text", Model?.EmploymentType), "Chọn hình thức", new { @class = "form-control" })
                            @Html.ValidationMessageFor(m => m.EmploymentType, "", new { @class = "text-danger" })
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group col-md-4">
                            <label for="SalaryFrom">Lương từ</label>
                            @Html.TextBoxFor(m => m.SalaryFrom, new { @class = "form-control", type = "number", step = "0.01", placeholder = "0" })
                            @Html.ValidationMessageFor(m => m.SalaryFrom, "", new { @class = "text-danger" })
                        </div>
                        <div class="form-group col-md-4">
                            <label for="SalaryTo">Lương đến</label>
                            @Html.TextBoxFor(m => m.SalaryTo, new { @class = "form-control", type = "number", step = "0.01", placeholder = "0" })
                            @Html.ValidationMessageFor(m => m.SalaryTo, "", new { @class = "text-danger" })
                        </div>
                        <div class="form-group col-md-4">
                            <label for="SalaryCurrency">Đơn vị tiền tệ</label>
                            @Html.DropDownListFor(m => m.SalaryCurrency, new SelectList(new[]
                            {
                                new SelectListItem { Text = "VND", Value = "VND" },
                                new SelectListItem { Text = "USD", Value = "USD" },
                                new SelectListItem { Text = "EUR", Value = "EUR" }
                            }, "Value", "Text", Model?.SalaryCurrency ?? "VND"), new { @class = "form-control" })
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="ApplicationDeadline">Hạn nộp hồ sơ</label>
                        @Html.TextBoxFor(m => m.ApplicationDeadline, new { @class = "form-control", type = "date" })
                        @Html.ValidationMessageFor(m => m.ApplicationDeadline, "", new { @class = "text-danger" })
                    </div>

                    <div class="form-group">
                        <label for="Description">Mô tả công việc</label>
                        <div id="description-editor" style="min-height: 200px; margin-bottom: 10px;"></div>
                        @Html.TextAreaFor(m => m.Description, new { @class = "form-control", id = "description-textarea", rows = "10", style = "display: none;", placeholder = "Mô tả chi tiết về công việc..." })
                        @Html.ValidationMessageFor(m => m.Description, "", new { @class = "text-danger" })
                    </div>

                    <div class="form-group">
                        <label for="Requirements">Yêu cầu</label>
                        <div id="requirements-editor" style="min-height: 200px; margin-bottom: 10px;"></div>
                        @Html.TextAreaFor(m => m.Requirements, new { @class = "form-control", id = "requirements-textarea", rows = "10", style = "display: none;", placeholder = "Yêu cầu về kỹ năng, kinh nghiệm..." })
                        @Html.ValidationMessageFor(m => m.Requirements, "", new { @class = "text-danger" })
                    </div>

                    <h3 class="text-black my-5 border-bottom pb-2">Chi tiết yêu cầu</h3>

                    <div class="form-row">
                        <div class="form-group col-md-6">
                            <label for="Industry">Ngành nghề <span class="text-danger">*</span></label>
                            @Html.TextBoxFor(m => m.Industry, new { @class = "form-control", placeholder = "Ví dụ: Công nghệ thông tin" })
                            @Html.ValidationMessageFor(m => m.Industry, "", new { @class = "text-danger" })
                        </div>
                        <div class="form-group col-md-6">
                            <label for="Major">Chuyên ngành</label>
                            @Html.TextBoxFor(m => m.Major, new { @class = "form-control", placeholder = "Ví dụ: Lập trình phần mềm" })
                            @Html.ValidationMessageFor(m => m.Major, "", new { @class = "text-danger" })
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group col-md-4">
                            <label for="YearsExperience">Số năm kinh nghiệm</label>
                            @Html.TextBoxFor(m => m.YearsExperience, new { @class = "form-control", type = "number", min = "0", max = "50", placeholder = "0" })
                            @Html.ValidationMessageFor(m => m.YearsExperience, "", new { @class = "text-danger" })
                        </div>
                        <div class="form-group col-md-4">
                            <label for="DegreeRequired">Bằng cấp yêu cầu</label>
                            @Html.DropDownListFor(m => m.DegreeRequired, new SelectList(new[]
                            {
                                new SelectListItem { Text = "Không yêu cầu", Value = "Không yêu cầu" },
                                new SelectListItem { Text = "Trung cấp", Value = "Trung cấp" },
                                new SelectListItem { Text = "Cao đẳng", Value = "Cao đẳng" },
                                new SelectListItem { Text = "Đại học", Value = "Đại học" },
                                new SelectListItem { Text = "Thạc sĩ", Value = "Thạc sĩ" },
                                new SelectListItem { Text = "Tiến sĩ", Value = "Tiến sĩ" }
                            }, "Value", "Text", Model?.DegreeRequired), "Chọn bằng cấp", new { @class = "form-control" })
                            @Html.ValidationMessageFor(m => m.DegreeRequired, "", new { @class = "text-danger" })
                        </div>
                        <div class="form-group col-md-4">
                            <label for="Headcount">Số lượng cần tuyển</label>
                            @Html.TextBoxFor(m => m.Headcount, new { @class = "form-control", type = "number", min = "1", max = "1000", placeholder = "1" })
                            @Html.ValidationMessageFor(m => m.Headcount, "", new { @class = "text-danger" })
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="Skills">Kỹ năng</label>
                        <div id="skills-editor" style="min-height: 150px; margin-bottom: 10px;"></div>
                        @Html.TextAreaFor(m => m.Skills, new { @class = "form-control", id = "skills-textarea", rows = "5", style = "display: none;", placeholder = "Ví dụ: C#, ASP.NET, SQL Server..." })
                        @Html.ValidationMessageFor(m => m.Skills, "", new { @class = "text-danger" })
                        <small class="form-text text-muted">Bạn có thể sử dụng các công cụ định dạng để tạo danh sách kỹ năng đẹp mắt</small>
                    </div>

                    <div class="form-row">
                        <div class="form-group col-md-4">
                            <label for="GenderRequirement">Yêu cầu giới tính</label>
                            @Html.DropDownListFor(m => m.GenderRequirement, new SelectList(new[]
                            {
                                new SelectListItem { Text = "Không yêu cầu", Value = "Not required" },
                                new SelectListItem { Text = "Nam", Value = "Nam" },
                                new SelectListItem { Text = "Nữ", Value = "Nữ" }
                            }, "Value", "Text", Model?.GenderRequirement ?? "Not required"), new { @class = "form-control" })
                            @Html.ValidationMessageFor(m => m.GenderRequirement, "", new { @class = "text-danger" })
                        </div>
                        <div class="form-group col-md-4">
                            <label for="AgeFrom">Độ tuổi từ</label>
                            @Html.TextBoxFor(m => m.AgeFrom, new { @class = "form-control", type = "number", min = "16", max = "100", placeholder = "16" })
                            @Html.ValidationMessageFor(m => m.AgeFrom, "", new { @class = "text-danger" })
                        </div>
                        <div class="form-group col-md-4">
                            <label for="AgeTo">Độ tuổi đến</label>
                            @Html.TextBoxFor(m => m.AgeTo, new { @class = "form-control", type = "number", min = "16", max = "100", placeholder = "100" })
                            @Html.ValidationMessageFor(m => m.AgeTo, "", new { @class = "text-danger" })
                        </div>
                    </div>

                    <div class="text-right mt-4">
                        <a href="@Url.Action("MyJobs", "Jobs")" class="btn btn-secondary btn-md mr-2">Hủy</a>
                        <button type="submit" class="btn btn-primary btn-md">@(isEditMode ? "Cập nhật tin tuyển dụng" : "Đăng tin tuyển dụng")</button>
                    </div>
                }
            </div>
        </div>
    </div>
</section>

<div class="modal fade" id="mapModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title text-primary"><i class="icon-map mr-2"></i>Chọn địa điểm làm việc</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="map-container-style mb-3">
                    <h6 class="text-primary mb-3"><i class="icon-search mr-2"></i>Tìm kiếm hoặc click vào bản đồ</h6>
                    <div id="mapPicker"></div>
                </div>
                <p class="text-muted small text-center mb-0">
                    * Sử dụng thanh tìm kiếm trên bản đồ để tìm nhanh vị trí tòa nhà/đường phố.
                </p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Đóng</button>
                <button type="button" class="btn btn-success" id="btnConfirmLocation">Xác nhận địa chỉ này</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @Scripts.Render("~/bundles/jqueryval")

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="https://unpkg.com/leaflet-geosearch@3.8.0/dist/geosearch.umd.js"></script>

    <script>
        $(document).ready(function () {
            var map;
            var marker;
            var currentAddress = "";

            function cleanAddress(fullAddress) {
                if (!fullAddress) return "";

                var parts = fullAddress.split(',');

                var cleanedParts = parts.filter(function(part) {
                    var text = part.trim();
                    return !(/^\d{5,6}$/.test(text));
                });

                return cleanedParts.join(',').trim();
            }

            function updateLocation(lat, lng, displayName) {
                if (!displayName) {
                    $.ajax({
                        url: `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1`,
                        type: 'GET',
                        headers: { 'Accept-Language': 'vi-VN' },
                        success: function (data) {
                            if (data && data.display_name) {
                                processAddress(data.display_name);
                            }
                        }
                    });
                } else {
                    processAddress(displayName);
                }

                function processAddress(rawAddress) {
                    var finalAddress = cleanAddress(rawAddress);
                    currentAddress = finalAddress;

                    if (marker) {
                        marker.setLatLng([lat, lng])
                              .bindPopup(finalAddress)
                              .openPopup();
                    } else {
                        marker = L.marker([lat, lng]).addTo(map)
                                  .bindPopup(finalAddress)
                                  .openPopup();
                    }

                    map.setView([lat, lng], 16);
                }
            }

            $('#mapModal').on('shown.bs.modal', function () {
                if (!map) {
                    map = L.map('mapPicker').setView([21.0285, 105.8542], 13);

                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '&copy; OpenStreetMap contributors'
                    }).addTo(map);

                    const provider = new GeoSearch.OpenStreetMapProvider({
                        params: {
                            'accept-language': 'vi',
                            countrycodes: 'vn',
                        },
                    });

                    const searchControl = new GeoSearch.GeoSearchControl({
                        provider: provider,
                        style: 'bar',
                        showMarker: false,
                        searchLabel: 'Nhập tên đường, tòa nhà...',
                        keepResult: true,
                        updateMap: false 
                    });

                    map.addControl(searchControl);

                    map.on('geosearch/showlocation', function (result) {
                        var lat = result.location.y;
                        var lng = result.location.x;
                        var label = result.location.label;
                        updateLocation(lat, lng, label);
                    });

                    map.on('click', function (e) {
                        updateLocation(e.latlng.lat, e.latlng.lng, null);
                    });
                } else {
                    setTimeout(function() { map.invalidateSize(); }, 100);
                }
            });

            $('#btnConfirmLocation').click(function() {
                if(currentAddress) {
                    $('#LocationInput').val(currentAddress);
                    $('#mapModal').modal('hide');
                    $('#LocationInput').valid();
                } else {
                    alert("Vui lòng chọn một vị trí trên bản đồ.");
                }
            });
        });

       // Initialize Quill editor for Description
    var quillDescription = new Quill('#description-editor', {
        theme: 'snow',
        modules: {
            toolbar: [
                [{ 'header': [1, 2, 3, false] }],
                ['bold', 'italic', 'underline', 'strike'],
                [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                ['blockquote', 'code-block'],
                ['link'],
                ['clean']
            ]
        },
        placeholder: 'Mô tả chi tiết về công việc...'
    });

    // Initialize Quill editor for Requirements
    var quillRequirements = new Quill('#requirements-editor', {
        theme: 'snow',
        modules: {
            toolbar: [
                [{ 'header': [1, 2, 3, false] }],
                ['bold', 'italic', 'underline', 'strike'],
                [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                ['blockquote', 'code-block'],
                ['link'],
                ['clean']
            ]
        },
        placeholder: 'Yêu cầu về kỹ năng, kinh nghiệm...'
    });

    // Initialize Quill editor for Skills
    var quillSkills = new Quill('#skills-editor', {
        theme: 'snow',
        modules: {
            toolbar: [
                ['bold', 'italic', 'underline'],
                [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                ['clean']
            ]
        },
        placeholder: 'Ví dụ: C#, ASP.NET, SQL Server...'
    });

    // Set initial content if exists
@if (Model != null && !string.IsNullOrEmpty(Model.Description))
{
    <text>
        var initialDescription = @Html.Raw(Json.Encode(Model.Description));
        quillDescription.root.innerHTML = initialDescription;
    </text>
}

@if (Model != null && !string.IsNullOrEmpty(Model.Requirements))
{
    <text>
        var initialRequirements = @Html.Raw(Json.Encode(Model.Requirements));
        quillRequirements.root.innerHTML = initialRequirements;
    </text>
}

@if (Model != null && !string.IsNullOrEmpty(Model.Skills))
{
    <text>
        var initialSkills = @Html.Raw(Json.Encode(Model.Skills));
        quillSkills.root.innerHTML = initialSkills;
    </text>
}

    // Update textarea fields before form submit
    var form = document.getElementById('job-create-form');
    if (form) {
        form.addEventListener('submit', function(e) {
            // Get HTML content from Quill editors BEFORE form submission
            var descriptionHtml = quillDescription.root.innerHTML;
            var requirementsHtml = quillRequirements.root.innerHTML;
            var skillsHtml = quillSkills.root.innerHTML;

            // Get textarea elements (they are hidden)
            var descriptionTextarea = document.getElementById('description-textarea');
            var requirementsTextarea = document.getElementById('requirements-textarea');
            var skillsTextarea = document.getElementById('skills-textarea');

            // Set values to textarea elements
            if (descriptionTextarea) {
                descriptionTextarea.value = descriptionHtml;
            }
            if (requirementsTextarea) {
                requirementsTextarea.value = requirementsHtml;
            }
            if (skillsTextarea) {
                skillsTextarea.value = skillsHtml;
            }

            // Let the form submit normally - don't prevent default
            // The values are already set, so the form will submit with correct data
        });
    }
    </script>
}