@model IEnumerable<Project_Recruiment_Huce.Models.Candidates.ResumeFileViewModel>

@{
    ViewBag.Title = "Quản lý CV";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@section Styles {
    <link rel="stylesheet" href="@Url.Content("~/Content/css/myresumes.css")" />
}

<section class="section-hero overlay inner-page bg-image" style="background-image: url('@Url.Content("~/Content/images/hero_1.jpg")');" id="home-section">
    <div class="container">
        <div class="row">
            <div class="col-md-7">
                <h1 class="text-white font-weight-bold">Quản lý CV</h1>
                <div class="custom-breadcrumbs">
                    <a href="@Url.Action("Index","Home")">Trang chủ</a> <span class="mx-2 slash">/</span>
                    <span class="text-white"><strong>Quản lý CV</strong></span>
                </div>
            </div>
        </div>
    </div>
</section>

<section class="site-section">
    <div class="container">
        <div class="row mb-5">
            <div class="col-lg-12">
                @if (TempData["SuccessMessage"] != null)
                {
                    <div class="alert alert-success alert-dismissible fade show" role="alert">
                        @TempData["SuccessMessage"]
                        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                }

                @if (TempData["ErrorMessage"] != null)
                {
                    <div class="alert alert-danger alert-dismissible fade show" role="alert">
                        @TempData["ErrorMessage"]
                        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                }

                <div class="mb-5">
                    <!-- Upload Form -->
                    <div class="upload-card shadow-sm">
                        <div class="upload-card-header">
                            <div class="d-flex align-items-center">
                                <span class="icon-cloud-upload upload-icon mr-3"></span>
                                <div>
                                    <h4 class="mb-1">Upload CV mới</h4>
                                    <p class="text-muted mb-0 small">Tải lên hồ sơ của bạn để ứng tuyển các vị trí phù hợp</p>
                                </div>
                            </div>
                        </div>
                        <div class="upload-card-body">
                            @using (Html.BeginForm("UploadResume", "ResumeFiles", FormMethod.Post, new { enctype = "multipart/form-data", id = "uploadForm" }))
                            {
                                @Html.AntiForgeryToken()
                                <div class="row">
                                    <div class="col-md-4 mb-3">
                                        <label for="title" class="form-label font-weight-bold">Tiêu đề CV <span class="text-danger">*</span></label>
                                        <input type="text" name="title" id="title" class="form-control form-control-modern" placeholder="Ví dụ: CV Frontend Developer" required />
                                    </div>
                                    <div class="col-md-5 mb-3">
                                        <label for="resumeFile" class="form-label font-weight-bold">Chọn file <span class="text-danger">*</span></label>
                                        <div class="custom-file-upload">
                                            <input type="file" name="resumeFile" id="resumeFile" class="file-input" accept=".pdf,.doc,.docx,.png,.jpg,.jpeg,.gif" required />
                                            <label for="resumeFile" class="file-label">
                                                <span class="icon-paperclip mr-2"></span>
                                                <span class="file-text">Chọn file từ máy tính</span>
                                            </label>
                                        </div>
                                        <small class="form-text text-muted mt-1">
                                            <span class="icon-info-circle mr-1"></span>PDF, DOC, DOCX, PNG, JPG, JPEG, GIF (Max: 10MB)
                                        </small>
                                    </div>
                                    <div class="col-md-3 mb-3">
                                        <label class="form-label font-weight-bold d-block">&nbsp;</label>
                                        <button type="submit" class="btn btn-primary btn-upload w-100">
                                            <span class="icon-upload mr-2"></span>Upload
                                        </button>
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                </div>

                <!-- Section Header -->
                <div class="section-header mb-4">
                    <h3 class="section-title">Danh sách CV của tôi</h3>
                    <p class="section-subtitle text-muted">Quản lý và theo dõi các hồ sơ ứng tuyển của bạn</p>
                </div>

                <!-- CV List -->
                @if (Model != null && Model.Any())
                {
                    <div class="row">
                        @foreach (var resume in Model)
                        {
                            <div class="col-md-6 col-lg-4 mb-4">
                                <div class="resume-card-modern h-100">
                                    <div class="resume-preview-wrapper">
                                        <!-- File Icon/Preview -->
                                        <div class="resume-preview">
                                            @if (resume.FileExtension == ".pdf")
                                            {
                            
                                                var pdfUrl = Url.Content("~" + resume.FilePath) + "#toolbar=0&navpanes=0&scrollbar=0"; 
                                                
                                                <iframe src="@pdfUrl" 
                                                        style="width: 100%; height: 100%; border: none; overflow: hidden !important;" // Đảm bảo CSS ẩn cuộn
                                                        scrolling="no"
                                                        frameborder="0"
                                                        allow="fullscreen">
                                                </iframe>
                                            }
                                            else if (resume.FileExtension == ".doc" || resume.FileExtension == ".docx")
                                            {
                                                <div class="file-icon-wrapper">
                                                    <i class="icon-file-word file-icon" style="color: #2b579a;"></i>
                                                    <span class="file-type-badge">DOCX</span>
                                                </div>
                                            }
                                            else if (resume.FileExtension == ".png" || resume.FileExtension == ".jpg" || resume.FileExtension == ".jpeg" || resume.FileExtension == ".gif")
                                            {
                                                <iframe src="@Url.Content("~" + resume.FilePath)" 
                                                        style="width: 100%; height: 100%; border: none; overflow: hidden !important; pointer-events: none;"
                                                        scrolling="no"
                                                        frameborder="0">
                                                </iframe>
                                            }
                                            else
                                            {
                                                <div class="file-icon-wrapper">
                                                    <i class="icon-file file-icon"></i>
                                                    <span class="file-type-badge">FILE</span>
                                                </div>
                                            }
                                        </div>
                                    </div>

                                    <div class="resume-card-content">
                                        <!-- Title - Editable -->
                                        <div class="resume-title-wrapper">
                                            <h5 class="resume-title-text" id="title_display_@resume.ResumeFileID">
                                                @resume.DisplayName
                                            </h5>
                                            @using (Html.BeginForm("EditResume", "ResumeFiles", FormMethod.Post, new { id = "editForm_" + resume.ResumeFileID, @class = "edit-form-inline" }))
                                            {
                                                @Html.AntiForgeryToken()
                                                @Html.Hidden("id", resume.ResumeFileID)
                                                <div class="input-group input-group-sm">
                                                    <input type="text" name="title" id="title_input_@resume.ResumeFileID" class="form-control" value="@resume.DisplayName" required />
                                                    <div class="input-group-append">
                                                        <button type="submit" class="btn btn-success btn-sm" title="Lưu">
                                                            <span class="icon-check"></span>
                                                        </button>
                                                        <button type="button" class="btn btn-secondary btn-sm cancel-edit" data-resume-id="@resume.ResumeFileID" title="Hủy">
                                                            <span class="icon-close"></span>
                                                        </button>
                                                    </div>
                                                </div>
                                            }
                                        </div>

                                        <!-- Upload Date -->
                                        <div class="resume-date">
                                            <span class="icon-calendar mr-1"></span>
                                            <span>@(resume.UploadedAt?.ToString("dd/MM/yyyy") ?? "N/A")</span>
                                        </div>

                                        <!-- Actions -->
                                        <div class="resume-actions">
                                            <a href="@Url.Content("~" + resume.FilePath)" target="_blank" class="btn-action btn-action-view">
                                                <span class="icon-eye"></span>
                                                <span>Xem</span>
                                            </a>
                                            <a href="@Url.Content("~" + resume.FilePath)" download class="btn-action btn-action-download">
                                                <span class="icon-download"></span>
                                                <span>Tải xuống</span>
                                            </a>
                                            <button type="button" class="btn-action btn-action-edit btn-edit-title" data-resume-id="@resume.ResumeFileID">
                                                <span class="icon-edit"></span>
                                                <span>Đổi tên</span>
                                            </button>
                                            @using (Html.BeginForm("DeleteResume", "ResumeFiles", FormMethod.Post, new { @class = "d-inline w-100", onsubmit = "return confirm('Bạn có chắc chắn muốn xóa CV này?');" }))
                                            {
                                                @Html.AntiForgeryToken()
                                                @Html.Hidden("id", resume.ResumeFileID)
                                                <button type="submit" class="btn-action btn-action-delete">
                                                    <span class="icon-trash"></span>
                                                    <span>Xóa</span>
                                                </button>
                                            }
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                }
                else
                {
                    <div class="empty-state">
                        <div class="empty-state-icon">
                            <span class="icon-folder-open"></span>
                        </div>
                        <h4 class="empty-state-title">Chưa có CV nào</h4>
                        <p class="empty-state-text">Bạn chưa có CV nào. Hãy upload CV đầu tiên của bạn để bắt đầu ứng tuyển!</p>
                    </div>
                }
            </div>
        </div>
    </div>
</section>

@section Scripts {
    <script>
        // Đảm bảo iframe không scroll và ẩn scrollbar
        document.addEventListener('DOMContentLoaded', function() {
            
            // Xử lý hiển thị tên file khi chọn
            $('#resumeFile').on('change', function(e) {
                var fileName = '';
                if (e.target.files && e.target.files.length > 0) {
                    fileName = e.target.files[0].name;
                    $(this).siblings('.file-label').find('.file-text').text(fileName);
                    $(this).siblings('.file-label').css('color', '#495057');
                } else {
                    $(this).siblings('.file-label').find('.file-text').text('Chọn file từ máy tính');
                    $(this).siblings('.file-label').css('color', '#6c757d');
                }
            });

            // Xử lý nút "Đổi tên" - hiện form inline
            $('.btn-edit-title').on('click', function() {
                var resumeId = $(this).data('resume-id');
                $('#title_display_' + resumeId).hide();
                $('#editForm_' + resumeId).show();
                $('#title_input_' + resumeId).focus().select();
            });

            // Xử lý nút hủy
            $('.cancel-edit').on('click', function() {
                var resumeId = $(this).data('resume-id');
                $('#editForm_' + resumeId).hide();
                $('#title_display_' + resumeId).show();
            });

            // Xử lý ESC key để hủy chỉnh sửa
            $('input[name="title"]').on('keydown', function(e) {
                if (e.key === 'Escape') {
                    var resumeId = $(this).attr('id').replace('title_input_', '');
                    $('#editForm_' + resumeId).hide();
                    $('#title_display_' + resumeId).show();
                }
            });
            var iframes = document.querySelectorAll('.resume-card iframe');
            iframes.forEach(function(iframe) {
                // Tắt scroll cho iframe
                iframe.setAttribute('scrolling', 'no');
                
                // Thử ẩn scrollbar trong iframe content (nếu có quyền truy cập)
                iframe.onload = function() {
                    try {
                        var iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                        if (iframeDoc) {
                            iframeDoc.body.style.overflow = 'hidden';
                            iframeDoc.documentElement.style.overflow = 'hidden';
                            // Ẩn scrollbar
                            iframeDoc.body.style.scrollbarWidth = 'none';
                            iframeDoc.body.style.msOverflowStyle = 'none';
                            if (iframeDoc.body.style.webkitOverflowScrolling !== undefined) {
                                iframeDoc.body.style.webkitOverflowScrolling = 'auto';
                            }
                        }
                    } catch (e) {
                        // Cross-origin hoặc không có quyền truy cập, bỏ qua
                    }
                };
            });
        });
    </script>
}

