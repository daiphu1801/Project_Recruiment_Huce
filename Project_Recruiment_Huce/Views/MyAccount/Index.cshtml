@model Project_Recruiment_Huce.Models.Accounts.MyAccountViewModel
@{
    ViewBag.Title = "Tài khoản của tôi";
    var changePasswordModel = ViewBag.ChangePasswordModel as Project_Recruiment_Huce.Models.Accounts.ChangePasswordViewModel ?? new Project_Recruiment_Huce.Models.Accounts.ChangePasswordViewModel();
}

@section Styles {
    <link rel="stylesheet" href="@Url.Content("~/Content/css/myaccount.css")" />
}

<section class="section-hero overlay inner-page bg-image" style="background-image: url('@Url.Content("~/Content/images/hero_1.jpg")');" id="home-section">
  <div class="container">
    <div class="row">
      <div class="col-md-7">
        <h1 class="text-white font-weight-bold">Tài khoản của tôi</h1>
        <div class="custom-breadcrumbs">
          <a href="@Url.Action("Index","Home")">Trang chủ</a> <span class="mx-2 slash">/</span>
          <span class="text-white"><strong>Tài khoản của tôi</strong></span>
        </div>
      </div>
    </div>
  </div>
</section>

<section class="site-section">
  <div class="container">
            
    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            @TempData["SuccessMessage"]
            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
        </div>
    }

    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            @TempData["ErrorMessage"]
            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
        </div>
    }

    <div class="row">
        <!-- Thông tin đăng nhập -->
        <div class="col-lg-6 mb-4">
            <div class="account-card">
                <div class="account-card-header">
                    <h3><span class="icon-user"></span> Thông tin đăng nhập</h3>
                </div>
                <div class="account-card-body">
                    <div class="info-group">
                        <label class="info-label">Tên đăng nhập</label>
                        <div class="info-value">@Model.Username</div>
                        <small class="info-hint">Không thể thay đổi</small>
                    </div>
                    <div class="info-group">
                        <label class="info-label">Email đăng nhập</label>
                        <div class="info-value">@(Model.LoginEmail ?? "-")</div>
                        <small class="info-hint">Dùng để đăng nhập và xử lý quên mật khẩu. Không thể thay đổi.</small>
                    </div>
                    <div class="info-group">
                        <label class="info-label">Email liên lạc</label>
                        <div class="info-value">@Html.Raw(Model.ContactEmail ?? "<em class='text-muted'>Chưa cập nhật</em>")</div>
                        <small class="info-hint">Email này được lấy từ hồ sơ của bạn. Bạn có thể cập nhật trong phần quản lý hồ sơ.</small>
                    </div>
                    <div class="info-group">
                        <label class="info-label">Số điện thoại</label>
                        <div class="info-value">@(Model.Phone ?? "-")</div>
                    </div>
                    <div class="info-group">
                        <label class="info-label">Vai trò</label>
                        <div class="info-value">
                            @if (Model.Role == "Candidate")
                            {
                                <span class="role-badge role-badge-candidate">Ứng viên</span>
                            }
                            else if (Model.Role == "Recruiter")
                            {
                                <span class="role-badge role-badge-recruiter">Nhà tuyển dụng</span>
                            }
                            else
                            {
                                <span class="role-badge role-badge-default">@Model.Role</span>
                            }
                        </div>
                    </div>
                    <div class="info-group">
                        <label class="info-label">Ngày tạo tài khoản</label>
                        <div class="info-value">@(Model.CreatedAt?.ToString("dd/MM/yyyy HH:mm") ?? "-")</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Đổi mật khẩu -->
        <div class="col-lg-6 mb-4">
            <div class="account-card">
                <div class="account-card-header">
                    <h3><span class="icon-lock"></span> Đổi mật khẩu</h3>
                </div>
                <div class="account-card-body">
                    @using (Html.BeginForm("ChangePassword", "MyAccount", FormMethod.Post, new { id = "changePasswordForm", @class = "compact-form" }))
                    {
                        @Html.AntiForgeryToken()
                        
                        @Html.ValidationSummary(false, "", new { @class = "validation-summary-errors", style = "display: none;" })

                        <div class="form-group-compact">
                            @Html.Label("CurrentPassword", "Mật khẩu hiện tại", new { @class = "form-label-compact" })
                            <div class="password-toggle-wrapper">
                                @Html.Password("CurrentPassword", changePasswordModel?.CurrentPassword, new { @class = "form-control-compact", required = "required", autocomplete = "current-password", id = "CurrentPassword", placeholder = "Nhập mật khẩu hiện tại" })
                                <span class="password-toggle-icon icon-eye" onclick="togglePassword('CurrentPassword', this)"></span>
                            </div>
                            @Html.ValidationMessage("CurrentPassword", "", new { @class = "text-danger validation-msg-compact" })
                        </div>

                        <div class="form-group-compact">
                            @Html.Label("NewPassword", "Mật khẩu mới", new { @class = "form-label-compact" })
                            <div class="password-toggle-wrapper">
                                @Html.Password("NewPassword", changePasswordModel?.NewPassword, new { @class = "form-control-compact", required = "required", minlength = "6", autocomplete = "new-password", id = "NewPassword", placeholder = "Nhập mật khẩu mới" })
                                <span class="password-toggle-icon icon-eye" onclick="togglePassword('NewPassword', this)"></span>
                            </div>
                            @Html.ValidationMessage("NewPassword", "", new { @class = "text-danger validation-msg-compact" })
                        </div>

                        <div class="form-group-compact">
                            @Html.Label("ConfirmPassword", "Xác nhận mật khẩu", new { @class = "form-label-compact" })
                            <div class="password-toggle-wrapper">
                                @Html.Password("ConfirmPassword", changePasswordModel?.ConfirmPassword, new { @class = "form-control-compact", required = "required", autocomplete = "new-password", id = "ConfirmPassword", placeholder = "Nhập lại mật khẩu mới" })
                                <span class="password-toggle-icon icon-eye" onclick="togglePassword('ConfirmPassword', this)"></span>
                            </div>
                            @Html.ValidationMessage("ConfirmPassword", "", new { @class = "text-danger validation-msg-compact" })
                        </div>

                        <div class="password-hint-box">
                            <span class="icon-info-circle"></span>
                            <small>Mật khẩu phải tối thiểu 6 ký tự, gồm chữ hoa, chữ thường và số</small>
                        </div>

                        <div class="form-group-compact mt-3">
                            <button type="submit" class="btn-change-password">
                                <span class="icon-key"></span>
                                <span>Đổi mật khẩu</span>
                            </button>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>

    <!-- Thông tin bổ sung -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="info-card">
                <div class="info-card-header">
                    <h3><span class="icon-info"></span> Thông tin bổ sung</h3>
                </div>
                <div class="info-card-content">
                    <p><strong>Email đăng nhập:</strong> Dùng để đăng nhập vào hệ thống và nhận mã token khi quên mật khẩu. Email này không thể thay đổi.</p>
                    <p><strong>Email liên lạc:</strong> Email này được lưu trong hồ sơ của bạn, dùng để nhà tuyển dụng/ứng viên liên hệ với bạn. Bạn có thể cập nhật email này trong phần quản lý hồ sơ.</p>
                    @if (Model.Role == "Candidate")
                    {
                        <p class="mb-0">
                            <a href="@Url.Action("CandidatesManage", "Candidates")" class="btn-modern">
                                <span class="icon-user"></span> Quản lý hồ sơ ứng viên
                            </a>
                        </p>
                    }
                    else if (Model.Role == "Recruiter")
                    {
                        <p class="mb-0">
                            <a href="@Url.Action("RecruitersManage", "Recruiters")" class="btn-modern">
                                <span class="icon-briefcase"></span> Quản lý hồ sơ nhà tuyển dụng
                            </a>
                        </p>
                    }
                </div>
            </div>
        </div>
    </div>
  </div>
</section>

@section Scripts {
    <script>
        $(document).ready(function() {
            // Ẩn validation summary nếu không có lỗi
            var validationSummary = $('.validation-summary-errors');
            if (validationSummary.length > 0) {
                var errorList = validationSummary.find('ul li');
                var hasErrors = false;
                
                errorList.each(function() {
                    if ($(this).text().trim() !== '' && $(this).css('display') !== 'none') {
                        hasErrors = true;
                    }
                });
                
                if (hasErrors) {
                    validationSummary.show();
                }
            }

            // Form validation
            $('#changePasswordForm').on('submit', function(e) {
                var form = this;
                if (form.checkValidity() === false) {
                    e.preventDefault();
                    e.stopPropagation();
                }
                $(form).addClass('was-validated');
            });
        });

        function togglePassword(inputId, iconElement) {
            var input = document.getElementById(inputId);
            if (input.type === "password") {
                input.type = "text";
                iconElement.classList.remove("icon-eye");
                iconElement.classList.add("icon-eye-slash");
            } else {
                input.type = "password";
                iconElement.classList.remove("icon-eye-slash");
                iconElement.classList.add("icon-eye");
            }
        }
    </script>
}

