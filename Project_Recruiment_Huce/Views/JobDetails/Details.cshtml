@model Project_Recruiment_Huce.Models.Jobs.JobDetailsViewModel

@{
    ViewBag.Title = "Chi tiết việc làm";
}

<section class="section-hero overlay inner-page bg-image" style="background-image: url('@Url.Content("~/Content/images/hero_1.jpg")');" id="home-section">
  <div class="container">
    <div class="row">
      <div class="col-md-7">
        <h1 class="text-white font-weight-bold">@(Model?.Title ?? "Chi tiết việc làm")</h1>
        <div class="custom-breadcrumbs">
          <a href="@Url.Action("Index","Home")">Trang chủ</a> <span class="mx-2 slash">/</span>
          <a href="@Url.Action("JobsListing","Jobs")">Việc làm</a> <span class="mx-2 slash">/</span>
          <span class="text-white"><strong>@(Model?.Title ?? "Chi tiết việc làm")</strong></span>
        </div>
      </div>
    </div>
  </div>
</section>

<section class="site-section">
  <div class="container">
    @if (TempData["SuccessMessage"] != null)
    {
      <div class="alert alert-success alert-dismissible fade show" role="alert" style="margin-top: 20px;">
        <i class="icon-check-circle mr-2"></i>
        <strong>Thành công!</strong> @TempData["SuccessMessage"]
        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
    }
    @if (TempData["ErrorMessage"] != null)
    {
      <div class="alert alert-danger alert-dismissible fade show" role="alert" style="margin-top: 20px;">
        <i class="icon-exclamation-circle mr-2"></i>
        <strong>Lỗi!</strong> @TempData["ErrorMessage"]
        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
    }
    @if (TempData["WarningMessage"] != null)
    {
      <div class="alert alert-warning alert-dismissible fade show" role="alert" style="margin-top: 20px;">
        <i class="icon-warning mr-2"></i>
        <strong>Cảnh báo!</strong> @TempData["WarningMessage"]
        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
    }
    <div class="row align-items-center mb-5">
      <div class="col-lg-8 mb-4 mb-lg-0">
        <div class="d-flex align-items-center">
          <div class="border p-2 d-inline-block mr-3 rounded">
            <img src="@(Model?.LogoUrl ?? Url.Content("~/Content/images/job_logo_1.jpg"))" alt="@(Model?.CompanyName ?? "N/A")" style="width: 120px; height: 120px; object-fit: contain;">
          </div>
          <div>
            <h2>@(Model?.Title ?? "")</h2>
            <div>
              <span class="ml-0 mr-2 mb-2"><span class="icon-briefcase mr-2"></span>@(Model?.CompanyName ?? "N/A")</span>
              @if (!string.IsNullOrEmpty(Model?.Location))
              {
                <span class="m-2"><span class="icon-room mr-2"></span>@Model.Location</span>
              }
              @if (!string.IsNullOrEmpty(Model?.EmploymentTypeDisplay))
              {
                <span class="m-2"><span class="icon-clock-o mr-2"></span><span class="text-primary">@Model.EmploymentTypeDisplay</span></span>
              }
            </div>
          </div>
        </div>
      </div>
      <div class="col-lg-4">
        <div class="row">
          @{
            var roleClaim = User.Identity.IsAuthenticated ? ((System.Security.Claims.ClaimsIdentity)User.Identity).FindFirst(System.Security.Claims.ClaimTypes.Role) : null;
            bool isCandidate = roleClaim != null && roleClaim.Value == "Candidate";
          }
          @if (isCandidate && Model != null && (Model.Status == "Published" || string.IsNullOrEmpty(Model.Status)))
          {
            <div class="col-6">
              <a href="@Url.Action("Apply", "Candidates", new { jobId = Model.JobPostID })" class="btn btn-block btn-primary btn-md">Ứng tuyển ngay</a>
            </div>
            <div class="col-6">
              @{
                bool isSaved = ViewBag.IsJobSaved != null && (bool)ViewBag.IsJobSaved;
              }
              <button type="button" 
                      class="btn btn-block @(isSaved ? "btn-warning" : "btn-secondary") btn-md btn-save-job" 
                      data-job-id="@Model.JobPostID"
                      data-is-saved="@(isSaved ? "true" : "false")">
                <span class="icon @(isSaved ? "icon-star" : "icon-star-empty") mr-1"></span>
                <span class="save-text">@(isSaved ? "Đã lưu" : "Lưu việc làm")</span>
              </button>
            </div>
          }
          else if (isCandidate && Model != null && (Model.Status == "Closed" || Model.Status == "Expired"))
          {
            <div class="col-12">
              <div class="alert alert-warning">
                <strong>Tin tuyển dụng này đã @(Model.Status == "Closed" ? "đóng" : "hết hạn")</strong>
                <p class="mb-0">Hiện tại không nhận đơn ứng tuyển mới.</p>
              </div>
            </div>
          }
        </div>
      </div>
    </div>
    <div class="row">
      <div class="col-lg-8">
        <div class="mb-5">
          @if (!string.IsNullOrEmpty(Model?.Description))
          {
            <h3 class="h5 d-flex align-items-center mb-4"><span class="icon-align-left mr-3"></span>Mô tả công việc</h3>
            <div class="job-description">
              @Html.Raw(Model.Description)
            </div>
          }
        </div>

        <div class="mb-5">
          @if (!string.IsNullOrEmpty(Model?.Requirements))
          {
            <h3 class="h5 d-flex align-items-center mb-4"><span class="icon-rocket mr-3"></span>Yêu cầu</h3>
            <div class="job-requirements">
              @Html.Raw(Model.Requirements)
            </div>
          }
        </div>
      </div>
      <div class="col-lg-4">
        <div class="bg-light p-3 border rounded mb-4">
          <h3 class="text-primary  mt-3 h5 pl-3 mb-3 ">Tóm tắt công việc</h3>
          <ul class="list-unstyled pl-3 mb-0">
            @if (Model?.PostedAt != null)
            {
              <li class="mb-2"><strong class="text-black">Ngày đăng:</strong> @Model.PostedAt.Value.ToString("dd/MM/yyyy")</li>
            }
            @if (!string.IsNullOrEmpty(Model?.EmploymentTypeDisplay))
            {
              <li class="mb-2"><strong class="text-black">Hình thức làm việc:</strong> @Model.EmploymentTypeDisplay</li>
            }
            @if (!string.IsNullOrEmpty(Model?.Location))
            {
              <li class="mb-2"><strong class="text-black">Địa điểm:</strong> @Model.Location</li>
            }
            @if (!string.IsNullOrEmpty(Model?.SalaryRange))
            {
              <li class="mb-2"><strong class="text-black">Lương:</strong> @Model.SalaryRange</li>
            }
            @if (Model?.ApplicationDeadline.HasValue ?? false)
            {
              bool isExpired = Model.ApplicationDeadline.Value < DateTime.Now;
              <li class="mb-2">
                <strong class="text-black">Hạn nộp hồ sơ:</strong> 
                @Model.ApplicationDeadline.Value.ToString("dd/MM/yyyy")
                @if (isExpired)
                {
                  <span class="badge badge-danger ml-2">Đã hết hạn</span>
                }
              </li>
            }
            @if (!string.IsNullOrEmpty(Model?.JobCode))
            {
              <li class="mb-2"><strong class="text-black">Mã công việc:</strong> @Model.JobCode</li>
            }
          </ul>
        </div>

        <div class="bg-light p-3 border rounded">
          <h3 class="text-primary  mt-3 h5 pl-3 mb-3 ">Chia sẻ</h3>
          <div class="px-3">
            <a href="#" class="pt-3 pb-3 pr-3 pl-0"><span class="icon-facebook"></span></a>
            <a href="#" class="pt-3 pb-3 pr-3 pl-0"><span class="icon-twitter"></span></a>
            <a href="#" class="pt-3 pb-3 pr-3 pl-0"><span class="icon-linkedin"></span></a>
            <a href="#" class="pt-3 pb-3 pr-3 pl-0"><span class="icon-pinterest"></span></a>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<section class="site-section" id="next">
  <div class="container">

    @{
      var relatedJobs = ViewBag.RelatedJobs as IEnumerable<Project_Recruiment_Huce.Models.Jobs.RelatedJobViewModel>;
    }
    
    @if (relatedJobs != null && relatedJobs.Any())
    {
      <div class="row mb-5 justify-content-center">
        <div class="col-md-7 text-center">
          <h2 class="section-title mb-2">Việc làm liên quan</h2>
        </div>
      </div>
      
      <ul class="job-listings mb-5">
        @foreach (var job in relatedJobs)
        {
          string badgeClass = "badge-success";
          if (!string.IsNullOrEmpty(job.EmploymentType))
          {
            string empType = job.EmploymentType.ToLower();
            if (empType == "part-time" || empType == "part time")
            {
              badgeClass = "badge-danger";
            }
          }
          
          <li class="job-listing d-block d-sm-flex pb-3 pb-sm-0 align-items-center">
            <a href="@Url.Action("JobDetails","Jobs", new { id = job.JobPostID })"></a>
            <div class="job-listing-logo">
              <img src="@job.LogoUrl" alt="@job.CompanyName" class="img-fluid">
            </div>

            <div class="job-listing-about d-sm-flex custom-width w-100 justify-content-between mx-4">
              <div class="job-listing-position custom-width w-50 mb-3 mb-sm-0">
                <h2>@job.Title</h2>
                <strong>@job.CompanyName</strong>
              </div>
              <div class="job-listing-location mb-3 mb-sm-0 custom-width w-25">
                @if (!string.IsNullOrEmpty(job.Location))
                {
                  <span class="icon-room"></span> @job.Location
                }
              </div>
              <div class="job-listing-meta">
                @if (!string.IsNullOrEmpty(job.EmploymentTypeDisplay))
                {
                  <span class="badge @badgeClass">@job.EmploymentTypeDisplay</span>
                }
              </div>
            </div>
          </li>
        }
      </ul>
    }

  </div>
</section>

<section class="bg-light pt-5 testimony-full">
    <div class="owl-carousel single-carousel">
      <div class="container">
        <div class="row">
          <div class="col-lg-6 align-self-center text-center text-lg-left">
            <blockquote>
              <p>&ldquo;JobBoard đã giúp tôi tìm được công việc mơ ước một cách nhanh chóng và dễ dàng. Giao diện thân thiện và hệ thống tìm kiếm thông minh giúp tôi nhanh chóng tìm thấy những cơ hội phù hợp với kỹ năng của mình.&rdquo;</p>
              <p><cite> &mdash; Bùi Đại Phú, Ứng viên</cite></p>
            </blockquote>
          </div>
          <div class="col-lg-6 align-self-end text-center text-lg-right">
            <img src="@Url.Content("~/Content/images/ảnh_bìa-removebg-preview.png")" alt="Phản hồi từ ứng viên" class="img-fluid mb-0">
          </div>
        </div>
      </div>

      <div class="container">
        <div class="row">
          <div class="col-lg-6 align-self-center text-center text-lg-left">
            <blockquote>
              <p>&ldquo;Là một nhà tuyển dụng, tôi rất hài lòng với JobBoard. Hệ thống giúp chúng tôi tiếp cận được nhiều ứng viên chất lượng và quản lý quy trình tuyển dụng một cách hiệu quả. Đây thực sự là công cụ tuyển dụng tốt nhất mà chúng tôi từng sử dụng.&rdquo;</p>
              <p><cite> &mdash; Nguyễn Minh Tiến, Nhà tuyển dụng</cite></p>
            </blockquote>
          </div>
          <div class="col-lg-6 align-self-end text-center text-lg-right">
            <img src="@Url.Content("~/Content/images/ảnh_bìa_2-removebg-preview-Photoroom.png")" alt="Phản hồi từ nhà tuyển dụng" class="img-fluid mb-0">
          </div>
        </div>
      </div>
    </div>
  </section>

@Html.AntiForgeryToken()

@section Scripts {
    <script>
        $(document).ready(function() {
            // Get anti-forgery token
            var token = $('input[name="__RequestVerificationToken"]').val();
            
            // Handle save/unsave job button
            $('.btn-save-job').on('click', function() {
                var btn = $(this);
                var jobId = btn.data('job-id');
                var isSaved = btn.data('is-saved') === 'true' || btn.data('is-saved') === true;
                var originalText = btn.find('.save-text').text();
                var originalClass = btn.attr('class');

                // Disable button during request
                btn.prop('disabled', true);
                btn.find('.save-text').text('Đang xử lý...');

                var url = isSaved ? '@Url.Action("UnsaveJob", "SavedJobs")' : '@Url.Action("SaveJob", "SavedJobs")';
                var action = isSaved ? 'unsave' : 'save';

                $.ajax({
                    url: url,
                    type: 'POST',
                    headers: {
                        'RequestVerificationToken': token
                    },
                    data: {
                        jobPostId: jobId,
                        __RequestVerificationToken: token
                    },
                    success: function(response) {
                        if (response.success) {
                            // Show success notification
                            showNotification(response.message, 'success');

                            // Update button state
                            if (isSaved) {
                                // Changed from saved to unsaved
                                btn.removeClass('btn-warning').addClass('btn-secondary');
                                btn.find('.icon').removeClass('icon-star').addClass('icon-star-empty');
                                btn.find('.save-text').text('Lưu việc làm');
                                btn.data('is-saved', 'false');
                            } else {
                                // Changed from unsaved to saved
                                btn.removeClass('btn-secondary').addClass('btn-warning');
                                btn.find('.icon').removeClass('icon-star-empty').addClass('icon-star');
                                btn.find('.save-text').text('Đã lưu');
                                btn.data('is-saved', 'true');
                            }
                        } else {
                            showNotification(response.message, 'error');
                            // Restore original state
                            btn.find('.save-text').text(originalText);
                        }
                    },
                    error: function() {
                        showNotification('Có lỗi xảy ra. Vui lòng thử lại.', 'error');
                        btn.find('.save-text').text(originalText);
                    },
                    complete: function() {
                        btn.prop('disabled', false);
                    }
                });
            });

            function showNotification(message, type) {
                var alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
                var alertHtml = '<div class="alert ' + alertClass + ' alert-dismissible fade show" role="alert" style="position: fixed; top: 20px; right: 20px; z-index: 9999; min-width: 300px;">' +
                    message +
                    '<button type="button" class="close" data-dismiss="alert" aria-label="Close">' +
                    '<span aria-hidden="true">&times;</span>' +
                    '</button>' +
                    '</div>';
                
                // Remove existing notifications
                $('.alert[role="alert"]').remove();
                
                // Add new notification
                $('body').append(alertHtml);
                
                // Auto dismiss after 3 seconds
                setTimeout(function() {
                    $('.alert[role="alert"]').fadeOut(300, function() {
                        $(this).remove();
                    });
                }, 3000);
            }
        });
    </script>
}

